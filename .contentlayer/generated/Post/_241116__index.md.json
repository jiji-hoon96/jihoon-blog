{
  "title": "Zustand 불변성 관리와 immer 미들웨어 동작 원리(valtio를 곁들인)",
  "date": "2024-11-16T00:00:00.000Z",
  "emoji": "🔥",
  "categories": "프론트엔드 자바스크립트",
  "body": {
    "raw": "\n![1.webp](1.webp)\n\nzustand의 immer 그리고 valtio에 대해 알아보기전에 불변성에 대해 간단히 알아보자.\n\n<br/>\n\n# 불변성\n\n불변성은 한번 생성된 데이터의 상태가 변경되지 않는다는 개념이다. \n\n직접 수정을 금지하고, 변경이 필요할 때 새로운 객체를 생성해 원본 데이터의 무결성을 유지해야한다.\n\n상태 변경이 직접적인 수정이 아닌 새로운 참조를 통해 이루어지므로, 상태 변화를 추적하고 예측하기 쉬워진다.\n\nReact의 렌더링 최적화는 참조 비교에 기반한다. 불변성을 통해 객체 참조 변경을 빠르게 확인하기에, 불필요한 렌더링을 방지할 수 있다.\n\n각 상태 변화에서 새로운 객체를 생성해 이전 상태를 보존할 수 있다. 이를 통해 상태 변화를 추적할 수 있다.\n\n<br/>\n\n\n## 참조 비교\n\n참조 비교는 메모리 관점에서 두 값이 동일한 메모리 주소를 가리키고 있는지를 확인하는 것을 의미한다.\n\n원시값은 값 자체를 비교하고, 참조값은 메모리 주소를 비교한다.\n\n얕은 비교는 객체의 최상위 레벨에서만 참조를 비교하고, 깊은 비교는 객체의 모든 중첩 레벨에서 값을 비교한다.\n\n## 메모리와 참조의 관계\n\n모든 객체는 고유한 메모리 주소를 가진다. 두 참조를 비교할 때는 실제 값이 아닌 메모리 주소를 비교한다.\n\n참조는 변수가 실제 데이터가 저장된 메모리 주소를 가리키는 포인터를 의미한다.\n\n\n<br>\n\n# zustand immer 미들웨어\n\n![3.png](3.png)\n\n<br/>\n\n깊은 객체 구조에서 수동으로 불변성을 관리하는 것은 복잡하고 에러가 발생하기 쉽다\n\n특히 스프레드 연산자, Object.assign() 같은 방식은 깊은 중첩 구조에서 코드가 매우 복잡해질 수 있다.\n\nimmer은 draft 객체를 이용해 객체를 직접 수정하는 것처럼 간단하게 처리할 수 있다.\n\n<br>\n\n## draft 객체\n\n불변성을 유지하면서도 마치 직접 객체를 수정하는 것처럼 코드를 작성할 수 있게 해주는 패턴을 의미한다.\n\n기존 상태를 복사하여 임시 객체(draft)를 만들고, 이를 수정한 후 최종적으로 새로운 불변 객체를 생성한다.\n\n```javascript\nconst baseState = {\n  name: \"John\",\n  age: 30,\n};\n\n// produce는 아래에서 설명\n\nconst nextState = produce(baseState, (draft) => {\n  draft.age += 1; // 마치 직접 수정하는 것처럼 보임\n});\n```\n\nProxy를 사용하여 모든 변경 사항을 추적한다.\n\n> 🙋🏻‍♂️ Proxy 란?\n>\n> ```javascript\n> const target = {\n>   name: \"John\",\n>   age: 30,\n> };\n>\n> const handler = {\n>   get: function (target, prop) {\n>     return target[prop];\n>   },\n>   set: function (target, prop, value) {\n>     target[prop] = value;\n>     return true;\n>   },\n> };\n>\n> const proxy = new Proxy(target, handler);\n> ```\n>\n> - 프록시는 객체에 대한 기본 동작(함수호출, 속성에 대한 접근, 속성 열거)를 가로채고 재정의 하는 것을 의미한다.\n>\n> - 원본 객체를 감싸는 가상의 객체를 생성한다.\n>\n> - 모든 작업을 중간에서 감시하고 제어한다. 미들웨어와 같은 개념이다.\n\n<br>\n\n실제로는 원본 객체를 수정하지 않고, 변경사항을 기록한다. 최종적으로 모든 변경사항을 적용한 새로운 불변 객체 생성한다.\n\n이것을 zustand에서 immer을 사용하는 코드로 변경하면 아래처럼 구조를 변경할 수 있다.\n\n```javascript\nimport create from \"zustand\";\nimport { immer } from \"zustand/middleware/immer\";\n\nconst useStore = create(\n  immer((set) => ({\n    users: [],\n    addUser: (user) =>\n      set((state) => {\n        state.users.push(user);\n      }),\n  }))\n);\n```\n\n<br/>\n\n## immerImpl\n\n상태를 보존하고 전파하는 코드는 여러 코드의 연관성을 통해 이루어진다.\n\n주제가 불변성인만큼 모든 코드를 깊이 분석하는 것보다 핵심 구현부인 immerImpl에 대해서 공부해보자.\n\n> [zustand immerImpl 내부코드](https://github.com/pmndrs/zustand/blob/main/src/middleware/immer.ts)\n\n```typescript\nconst immerImpl: ImmerImpl = (initializer) => (set, get, store) => {\n  type T = ReturnType<typeof initializer>;\n\n  store.setState = (updater, replace, ...a) => {\n    const nextState = (\n      typeof updater === \"function\" ? produce(updater as any) : updater\n    ) as ((s: T) => T) | T | Partial<T>;\n\n    return set(nextState, replace as any, ...a);\n  };\n\n  return initializer(store.setState, get, store);\n};\n```\n\n우선 immerImpl 함수는 store creator를 받아서 새로운 store creator을 반환하는 고차 함수다.\n\n> store creator\n>\n> - Zustand에서 상태(state)와 액션(actions)을 포함하는 스토어를 생성하는 함수\n> - set(상태 업데이트 함수), get(현재 상태를 가져오는 함수), store(스토어 객체 자체에 대한 참조)로 구성됨\n\nstore의 setState를 재정의한다.\n\n그 다음 updater을 처리하는데, updater이 함수인 경우와 아닌 경우를 구분해서 함수면 Immer의 produce로 감싸서 불변성을 보장하고, 아니면 객체 그대로 사용한다.\n\n마지막으로 원본 set 함수를 호출하고, 수정된 setState로 initializer을 반환한다.\n\n<br/>\n\n### produce 함수\n\n```typescript\nfunction produce<Base, Return>(\n  base: Base,\n  recipe: (draft: Draft<Base>) => Return,\n  patchListener?: PatchListener\n): Base extends undefined ? Return : Return extends undefined ? Base : Return;\n```\n\nproduce 함수는 현재 상태의 Base, 상태를 수정하는 함수 recipe(진짜 github에서 타입명 recipe로 되어있음), patchListener로 구성되어있다.\n\n프록시 객체인(draft)를 생성하고, recipe 함수를 실행 및 수정사항을 추적한다.\n\n변경사항을 분석해서 새로운 상태를 생성해 변경사항이 있을때 변경을 적용해서, 없으면 원본을 반환한다.\n\n<br/>\n\n### 타입 안전성 보장\n\n```typescript\nas((s: T) => T) | T | Partial<T>;\n```\n\n위 코드가 이해가 안되어서 찾아보니, 함수, 전체 상태 객체, 부분 상태 객체 모두 지원하기 위해서 반환값의 타입을 명시적으로 지정한것이라 한다.\n\n<br/>\n\n![4.jpeg](4.jpeg)\n\n## 그래서 완전한 불변성을 보장할까?\n\nzustand immer는 완벽한 불변성을 보장하지는 못한다.\n\n특정한 상황을 꼽지는 못하겠지만, 외부 참조에 대한 문제 발생, 다른 참조에 mutation 할 수 있고, 깊은 중첩에서 부분 업데이트를 할 때 안전성이 떨어지는 등 다양한 문제를 야기한다.\n\n그리고 아래와같은 javascript 언어적 특성도 불변성 완전 보장에 문제를 야기한다.\n\n- JavaScript의 객체는 기본적으로 참조로 전달된다. 얕은 복사만으로는 깊은 중첩 객체의 불변성을 보장할 수 없고, const도 참조의 재할당만 막을 뿐, 내부 속성 변경은 막지 못한다.\n\n- Object.freeze()가 shallow freeze만 제공한다.\n\n- 배열 메서드들이 원본을 직접 수정하는 경우가 많음 (이거는 나쁜 버릇이긴한데 많은 개발자가 배열 메서드의 참조개념을 잘 활용하지못하고 있다 생각함)\n\n- Object.seal()이나 Object.preventExtensions()도 완벽한 불변성을 제공하지 않는다.\n\n- 프로토타입을 통한 우회적 접근 가능하고, 프로토타입 체인 수정을 통한 동작 변경 가능하다. 상속된 속성은 더 예상치 못한 영향을 초래하기도 한다.\n\n이런 상황에서 어떻게 대응해야할까? 그래서 zustand discord에 문의했다\n\n![이미지1](image.png)\n\n특별한 문제없으면 Object freeze()를 사용하라고 제안받았다.\n\n성능상에 큰 문제가 없는지 재질문을 했더니, 성능에 많은 영향을 주지않는다는 답변을 받았다.\n\n이런 저런 수다를 나누었다. \n\n2일뒤 zustand maintainer(Daishi Kato)가 왔다. immer로는 완전한 불변성 보장이 힘들기에 valtio를 만들었다한다.\n\n![이미지2](image2.png)\n\n그래서 알아보러 간다. Valtio\n\n![5.png](5.png)\n\n<br>\n\n# valtio\n\nzustand immer을 알아보다가 여기까지 왔다. 조금만 더 힘내보자! \n\n나는 valtio에 대해 모른다. 하지만 공부하다보니 valtio는 좋은 라이브러리라고 생각한다. (나중에 큰 챕터에서 다뤄보고, 여기서는 간단하게 알아보자!)\n\nvaltio와 zustand immer에서 가장 큰 차이점은 proxy의 사용 방식이다.\n\n<br/>\n\n\n## immer\n\n상태 업데이트 시에만 일시적으로 프록시를 생성한다.\n\n[immerjs의 produce 함수](https://github.com/immerjs/immer/blob/main/src/core/immerClass.ts)가 실행되는 동안에만 프록시가 존재하고, 업데이트가 완료되면 모든 변경사항을 기록했다가 한번에 새로운 불변 객체를 생성한다.\n\n```javascript\nproduce(state, (draft) => {\n  draft.count += 1; // 불변성을 신경쓰지 않고 직접 수정\n});\n```\n\n<br/>\n\n## valtio\n\n상태 객체를 처음 생성할 때부터 프록시로 래핑하고, 이 프록시는 지속적으로 유지된다.\n\nproxy-compare를 사용하여 상태 변경을 실시간으로 감지하고 추적한다. 곧 설명하겠지만 subscribe 함수를 통해 변경사항을 실시간으로 전파한다.\n\n쉽게 표현하면 모든 상태 변경이 프록시를 통해 이뤄지므로 실수로 인한 직접 수정을 방지해 연속적인 상태 추적이 가능하다.\n\n```javascript\nstate.count += 1; // 프록시가 자동으로 변경을 감지하고 처리\n```\n\n<br/>\n\n## 어떤 코드 동작으로 immer와 다르게 동작할까?\n\n```typescript\nconst createHandlerDefault = <T extends object>(\n  isInitializing: () => boolean,\n  addPropListener: (prop: string | symbol, propValue: unknown) => void,\n  removePropListener: (prop: string | symbol) => void,\n  notifyUpdate: (op: Op) => void\n): ProxyHandler<T> => ({\n  deleteProperty(target: T, prop: string | symbol) {\n    const prevValue = Reflect.get(target, prop);\n    removePropListener(prop);\n    const deleted = Reflect.deleteProperty(target, prop);\n    if (deleted) {\n      notifyUpdate([\"delete\", [prop], prevValue]);\n    }\n    return deleted;\n  },\n  set(target: T, prop: string | symbol, value: any, receiver: object) {\n    const hasPrevValue = !isInitializing() && Reflect.has(target, prop);\n    const prevValue = Reflect.get(target, prop, receiver);\n\n    // objectIs를 통해 캐시된 이전값과 현재 값을 계속 확인한다. 그리고 동일하면 업데이트를 방지한다.\n    if (\n      hasPrevValue &&\n      (objectIs(prevValue, value) ||\n        (proxyCache.has(value) && objectIs(prevValue, proxyCache.get(value))))\n    ) {\n      return true;\n    }\n\n    removePropListener(prop);\n    if (isObject(value)) {\n      value = getUntracked(value) || value;\n    }\n\n    // 중첩된 객체도 자동으로 프록시화 => 이것이 가장 큰 차이같다. immer는 객체 생성할 때, produce 내에서만 불변성을 관리하지만 valtio는 지속적으로 관찰 비교한다.\n    const nextValue =\n      !proxyStateMap.has(value) && canProxy(value) ? proxy(value) : value;\n\n    addPropListener(prop, nextValue);\n    Reflect.set(target, prop, nextValue, receiver);\n    notifyUpdate([\"set\", [prop], value, prevValue]);\n    return true;\n  },\n});\n```\n\n다 안봐도 괜찮다. 주석 작성해둔 부분만 봐도 충분하다. \n\n나는 valtio를 좋은 라이브러리라고 생각한다. 하지만 valtio를 아직 사용하기에는 타입추론이나 호환성 이슈등 고려해야할 부분이 아직까지 존재하기에 다양한 테스트를 통해 도입을 고려해봐야한다 생각한다.\n\n<br/>\n\n## 마지막으로 valtio 장점을 어필해보면\n\n메모리 사용량이 낮다. 왜냐면 프록시를 계속 유지하면서 실제 변경된 부분만 업데이트하기때문이다.\n\ntargetCache와 snapCache를 사용하여 불필요한 재생성을 방지하고, 변경된 부분만 효율적으로 업데이트하기에 성능 저하의 우려가 적다.\n\nuseSnapshot 훅을 제공하여 리액트와 긴밀하게 통합되며, 컴포넌트 레벨에서 최적화된 리렌더링을 지원한다.\n\n실시간 변경을 주로 다루는 부분에서는 valtio 활용이 좋다고 보인다.\n\n```toc\n\n```\n",
    "html": "<p><img src=\"/content/241116/1.webp\" alt=\"1.webp\"></p>\n<p>zustand의 immer 그리고 valtio에 대해 알아보기전에 불변성에 대해 간단히 알아보자.</p>\n<h1 id=\"불변성\"><a class=\"anchor\" href=\"#불변성\">불변성</a></h1>\n<p>불변성은 한번 생성된 데이터의 상태가 변경되지 않는다는 개념이다.</p>\n<p>직접 수정을 금지하고, 변경이 필요할 때 새로운 객체를 생성해 원본 데이터의 무결성을 유지해야한다.</p>\n<p>상태 변경이 직접적인 수정이 아닌 새로운 참조를 통해 이루어지므로, 상태 변화를 추적하고 예측하기 쉬워진다.</p>\n<p>React의 렌더링 최적화는 참조 비교에 기반한다. 불변성을 통해 객체 참조 변경을 빠르게 확인하기에, 불필요한 렌더링을 방지할 수 있다.</p>\n<p>각 상태 변화에서 새로운 객체를 생성해 이전 상태를 보존할 수 있다. 이를 통해 상태 변화를 추적할 수 있다.</p>\n<h2 id=\"참조-비교\"><a class=\"anchor\" href=\"#참조-비교\">참조 비교</a></h2>\n<p>참조 비교는 메모리 관점에서 두 값이 동일한 메모리 주소를 가리키고 있는지를 확인하는 것을 의미한다.</p>\n<p>원시값은 값 자체를 비교하고, 참조값은 메모리 주소를 비교한다.</p>\n<p>얕은 비교는 객체의 최상위 레벨에서만 참조를 비교하고, 깊은 비교는 객체의 모든 중첩 레벨에서 값을 비교한다.</p>\n<h2 id=\"메모리와-참조의-관계\"><a class=\"anchor\" href=\"#메모리와-참조의-관계\">메모리와 참조의 관계</a></h2>\n<p>모든 객체는 고유한 메모리 주소를 가진다. 두 참조를 비교할 때는 실제 값이 아닌 메모리 주소를 비교한다.</p>\n<p>참조는 변수가 실제 데이터가 저장된 메모리 주소를 가리키는 포인터를 의미한다.</p>\n<h1 id=\"zustand-immer-미들웨어\"><a class=\"anchor\" href=\"#zustand-immer-미들웨어\">zustand immer 미들웨어</a></h1>\n<p><img src=\"/content/241116/3.png\" alt=\"3.png\"></p>\n<p>깊은 객체 구조에서 수동으로 불변성을 관리하는 것은 복잡하고 에러가 발생하기 쉽다</p>\n<p>특히 스프레드 연산자, Object.assign() 같은 방식은 깊은 중첩 구조에서 코드가 매우 복잡해질 수 있다.</p>\n<p>immer은 draft 객체를 이용해 객체를 직접 수정하는 것처럼 간단하게 처리할 수 있다.</p>\n<h2 id=\"draft-객체\"><a class=\"anchor\" href=\"#draft-객체\">draft 객체</a></h2>\n<p>불변성을 유지하면서도 마치 직접 객체를 수정하는 것처럼 코드를 작성할 수 있게 해주는 패턴을 의미한다.</p>\n<p>기존 상태를 복사하여 임시 객체(draft)를 만들고, 이를 수정한 후 최종적으로 새로운 불변 객체를 생성한다.</p>\n<figure data-rehype-pretty-code-figure=\"\"><pre tabindex=\"0\" data-language=\"javascript\" data-theme=\"github-dark github-light\"><code data-language=\"javascript\" data-theme=\"github-dark github-light\" style=\"display: grid;\"><span data-line=\"\"><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">const</span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> baseState</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\"> =</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> {</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">  name: </span><span style=\"--shiki-dark:#9ECBFF;--shiki-light:#032F62\">\"John\"</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">,</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">  age: </span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\">30</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">,</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">};</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"--shiki-dark:#6A737D;--shiki-light:#6A737D\">// produce는 아래에서 설명</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">const</span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> nextState</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\"> =</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\"> produce</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">(baseState, (</span><span style=\"--shiki-dark:#FFAB70;--shiki-light:#E36209\">draft</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">) </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">=></span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> {</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">  draft.age </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">+=</span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> 1</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">; </span><span style=\"--shiki-dark:#6A737D;--shiki-light:#6A737D\">// 마치 직접 수정하는 것처럼 보임</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">});</span></span></code></pre></figure>\n<p>Proxy를 사용하여 모든 변경 사항을 추적한다.</p>\n<blockquote>\n<p>🙋🏻‍♂️ Proxy 란?</p>\n<figure data-rehype-pretty-code-figure=\"\"><pre tabindex=\"0\" data-language=\"javascript\" data-theme=\"github-dark github-light\"><code data-language=\"javascript\" data-theme=\"github-dark github-light\" style=\"display: grid;\"><span data-line=\"\"><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">const</span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> target</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\"> =</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> {</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">  name: </span><span style=\"--shiki-dark:#9ECBFF;--shiki-light:#032F62\">\"John\"</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">,</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">  age: </span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\">30</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">,</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">};</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">const</span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> handler</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\"> =</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> {</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">  get</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">: </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">function</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> (</span><span style=\"--shiki-dark:#FFAB70;--shiki-light:#E36209\">target</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">, </span><span style=\"--shiki-dark:#FFAB70;--shiki-light:#E36209\">prop</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">) {</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">    return</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> target[prop];</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">  },</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">  set</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">: </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">function</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> (</span><span style=\"--shiki-dark:#FFAB70;--shiki-light:#E36209\">target</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">, </span><span style=\"--shiki-dark:#FFAB70;--shiki-light:#E36209\">prop</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">, </span><span style=\"--shiki-dark:#FFAB70;--shiki-light:#E36209\">value</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">) {</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">    target[prop] </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">=</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> value;</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">    return</span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> true</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">;</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">  },</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">};</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">const</span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> proxy</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\"> =</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\"> new</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\"> Proxy</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">(target, handler);</span></span></code></pre></figure>\n<ul>\n<li>\n<p>프록시는 객체에 대한 기본 동작(함수호출, 속성에 대한 접근, 속성 열거)를 가로채고 재정의 하는 것을 의미한다.</p>\n</li>\n<li>\n<p>원본 객체를 감싸는 가상의 객체를 생성한다.</p>\n</li>\n<li>\n<p>모든 작업을 중간에서 감시하고 제어한다. 미들웨어와 같은 개념이다.</p>\n</li>\n</ul>\n</blockquote>\n<p>실제로는 원본 객체를 수정하지 않고, 변경사항을 기록한다. 최종적으로 모든 변경사항을 적용한 새로운 불변 객체 생성한다.</p>\n<p>이것을 zustand에서 immer을 사용하는 코드로 변경하면 아래처럼 구조를 변경할 수 있다.</p>\n<figure data-rehype-pretty-code-figure=\"\"><pre tabindex=\"0\" data-language=\"javascript\" data-theme=\"github-dark github-light\"><code data-language=\"javascript\" data-theme=\"github-dark github-light\" style=\"display: grid;\"><span data-line=\"\"><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">import</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> create </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">from</span><span style=\"--shiki-dark:#9ECBFF;--shiki-light:#032F62\"> \"zustand\"</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">;</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">import</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> { immer } </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">from</span><span style=\"--shiki-dark:#9ECBFF;--shiki-light:#032F62\"> \"zustand/middleware/immer\"</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">;</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">const</span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> useStore</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\"> =</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\"> create</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">(</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">  immer</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">((</span><span style=\"--shiki-dark:#FFAB70;--shiki-light:#E36209\">set</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">) </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">=></span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> ({</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">    users: [],</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">    addUser</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">: (</span><span style=\"--shiki-dark:#FFAB70;--shiki-light:#E36209\">user</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">) </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">=></span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">      set</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">((</span><span style=\"--shiki-dark:#FFAB70;--shiki-light:#E36209\">state</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">) </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">=></span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> {</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">        state.users.</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">push</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">(user);</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">      }),</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">  }))</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">);</span></span></code></pre></figure>\n<h2 id=\"immerimpl\"><a class=\"anchor\" href=\"#immerimpl\">immerImpl</a></h2>\n<p>상태를 보존하고 전파하는 코드는 여러 코드의 연관성을 통해 이루어진다.</p>\n<p>주제가 불변성인만큼 모든 코드를 깊이 분석하는 것보다 핵심 구현부인 immerImpl에 대해서 공부해보자.</p>\n<blockquote>\n<p><a href=\"https://github.com/pmndrs/zustand/blob/main/src/middleware/immer.ts\">zustand immerImpl 내부코드</a></p>\n</blockquote>\n<figure data-rehype-pretty-code-figure=\"\"><pre tabindex=\"0\" data-language=\"typescript\" data-theme=\"github-dark github-light\"><code data-language=\"typescript\" data-theme=\"github-dark github-light\" style=\"display: grid;\"><span data-line=\"\"><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">const</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\"> immerImpl</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">:</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\"> ImmerImpl</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\"> =</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> (</span><span style=\"--shiki-dark:#FFAB70;--shiki-light:#E36209\">initializer</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">) </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">=></span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> (</span><span style=\"--shiki-dark:#FFAB70;--shiki-light:#E36209\">set</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">, </span><span style=\"--shiki-dark:#FFAB70;--shiki-light:#E36209\">get</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">, </span><span style=\"--shiki-dark:#FFAB70;--shiki-light:#E36209\">store</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">) </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">=></span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> {</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">  type</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\"> T</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\"> =</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\"> ReturnType</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">&#x3C;</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">typeof</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> initializer>;</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">  store.</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">setState</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\"> =</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> (</span><span style=\"--shiki-dark:#FFAB70;--shiki-light:#E36209\">updater</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">, </span><span style=\"--shiki-dark:#FFAB70;--shiki-light:#E36209\">replace</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">, </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">...</span><span style=\"--shiki-dark:#FFAB70;--shiki-light:#E36209\">a</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">) </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">=></span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> {</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">    const</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\"> nextState</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\"> =</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> (</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">      typeof</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> updater </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">===</span><span style=\"--shiki-dark:#9ECBFF;--shiki-light:#032F62\"> \"function\"</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\"> ?</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\"> produce</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">(updater </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">as</span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> any</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">) </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">:</span><span style=\"--shiki-dark:#FFAB70;--shiki-light:#E36209\"> updater</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">    ) </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">as</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> ((</span><span style=\"--shiki-dark:#FFAB70;--shiki-light:#E36209\">s</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">:</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\"> T</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">) </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">=></span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\"> T</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">) </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">|</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\"> T</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\"> |</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\"> Partial</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">&#x3C;</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">T</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">>;</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">    return</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\"> set</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">(nextState, replace </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">as</span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> any</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">, </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">...</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">a);</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">  };</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">  return</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\"> initializer</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">(store.setState, get, store);</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">};</span></span></code></pre></figure>\n<p>우선 immerImpl 함수는 store creator를 받아서 새로운 store creator을 반환하는 고차 함수다.</p>\n<blockquote>\n<p>store creator</p>\n<ul>\n<li>Zustand에서 상태(state)와 액션(actions)을 포함하는 스토어를 생성하는 함수</li>\n<li>set(상태 업데이트 함수), get(현재 상태를 가져오는 함수), store(스토어 객체 자체에 대한 참조)로 구성됨</li>\n</ul>\n</blockquote>\n<p>store의 setState를 재정의한다.</p>\n<p>그 다음 updater을 처리하는데, updater이 함수인 경우와 아닌 경우를 구분해서 함수면 Immer의 produce로 감싸서 불변성을 보장하고, 아니면 객체 그대로 사용한다.</p>\n<p>마지막으로 원본 set 함수를 호출하고, 수정된 setState로 initializer을 반환한다.</p>\n<h3 id=\"produce-함수\"><a class=\"anchor\" href=\"#produce-함수\">produce 함수</a></h3>\n<figure data-rehype-pretty-code-figure=\"\"><pre tabindex=\"0\" data-language=\"typescript\" data-theme=\"github-dark github-light\"><code data-language=\"typescript\" data-theme=\"github-dark github-light\" style=\"display: grid;\"><span data-line=\"\"><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">function</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\"> produce</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">&#x3C;</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">Base</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">, </span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">Return</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">>(</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#FFAB70;--shiki-light:#E36209\">  base</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">:</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\"> Base</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">,</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">  recipe</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">:</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> (</span><span style=\"--shiki-dark:#FFAB70;--shiki-light:#E36209\">draft</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">:</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\"> Draft</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">&#x3C;</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">Base</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">>) </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">=></span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\"> Return</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">,</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#FFAB70;--shiki-light:#E36209\">  patchListener</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">?:</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\"> PatchListener</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">)</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">:</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\"> Base</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\"> extends</span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> undefined</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\"> ?</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\"> Return</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\"> :</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\"> Return</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\"> extends</span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> undefined</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\"> ?</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\"> Base</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\"> :</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\"> Return</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">;</span></span></code></pre></figure>\n<p>produce 함수는 현재 상태의 Base, 상태를 수정하는 함수 recipe(진짜 github에서 타입명 recipe로 되어있음), patchListener로 구성되어있다.</p>\n<p>프록시 객체인(draft)를 생성하고, recipe 함수를 실행 및 수정사항을 추적한다.</p>\n<p>변경사항을 분석해서 새로운 상태를 생성해 변경사항이 있을때 변경을 적용해서, 없으면 원본을 반환한다.</p>\n<h3 id=\"타입-안전성-보장\"><a class=\"anchor\" href=\"#타입-안전성-보장\">타입 안전성 보장</a></h3>\n<figure data-rehype-pretty-code-figure=\"\"><pre tabindex=\"0\" data-language=\"typescript\" data-theme=\"github-dark github-light\"><code data-language=\"typescript\" data-theme=\"github-dark github-light\" style=\"display: grid;\"><span data-line=\"\"><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">as</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">((</span><span style=\"--shiki-dark:#FFAB70;--shiki-light:#E36209\">s</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">:</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\"> T</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">) </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">=></span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> T</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">) </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">|</span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> T</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\"> |</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> Partial</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">&#x3C;</span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\">T</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">></span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">;</span></span></code></pre></figure>\n<p>위 코드가 이해가 안되어서 찾아보니, 함수, 전체 상태 객체, 부분 상태 객체 모두 지원하기 위해서 반환값의 타입을 명시적으로 지정한것이라 한다.</p>\n<p><img src=\"/content/241116/4.jpeg\" alt=\"4.jpeg\"></p>\n<h2 id=\"그래서-완전한-불변성을-보장할까\"><a class=\"anchor\" href=\"#그래서-완전한-불변성을-보장할까\">그래서 완전한 불변성을 보장할까?</a></h2>\n<p>zustand immer는 완벽한 불변성을 보장하지는 못한다.</p>\n<p>특정한 상황을 꼽지는 못하겠지만, 외부 참조에 대한 문제 발생, 다른 참조에 mutation 할 수 있고, 깊은 중첩에서 부분 업데이트를 할 때 안전성이 떨어지는 등 다양한 문제를 야기한다.</p>\n<p>그리고 아래와같은 javascript 언어적 특성도 불변성 완전 보장에 문제를 야기한다.</p>\n<ul>\n<li>\n<p>JavaScript의 객체는 기본적으로 참조로 전달된다. 얕은 복사만으로는 깊은 중첩 객체의 불변성을 보장할 수 없고, const도 참조의 재할당만 막을 뿐, 내부 속성 변경은 막지 못한다.</p>\n</li>\n<li>\n<p>Object.freeze()가 shallow freeze만 제공한다.</p>\n</li>\n<li>\n<p>배열 메서드들이 원본을 직접 수정하는 경우가 많음 (이거는 나쁜 버릇이긴한데 많은 개발자가 배열 메서드의 참조개념을 잘 활용하지못하고 있다 생각함)</p>\n</li>\n<li>\n<p>Object.seal()이나 Object.preventExtensions()도 완벽한 불변성을 제공하지 않는다.</p>\n</li>\n<li>\n<p>프로토타입을 통한 우회적 접근 가능하고, 프로토타입 체인 수정을 통한 동작 변경 가능하다. 상속된 속성은 더 예상치 못한 영향을 초래하기도 한다.</p>\n</li>\n</ul>\n<p>이런 상황에서 어떻게 대응해야할까? 그래서 zustand discord에 문의했다</p>\n<p><img src=\"/content/241116/image.png\" alt=\"이미지1\"></p>\n<p>특별한 문제없으면 Object freeze()를 사용하라고 제안받았다.</p>\n<p>성능상에 큰 문제가 없는지 재질문을 했더니, 성능에 많은 영향을 주지않는다는 답변을 받았다.</p>\n<p>이런 저런 수다를 나누었다.</p>\n<p>2일뒤 zustand maintainer(Daishi Kato)가 왔다. immer로는 완전한 불변성 보장이 힘들기에 valtio를 만들었다한다.</p>\n<p><img src=\"/content/241116/image2.png\" alt=\"이미지2\"></p>\n<p>그래서 알아보러 간다. Valtio</p>\n<p><img src=\"/content/241116/5.png\" alt=\"5.png\"></p>\n<h1 id=\"valtio\"><a class=\"anchor\" href=\"#valtio\">valtio</a></h1>\n<p>zustand immer을 알아보다가 여기까지 왔다. 조금만 더 힘내보자!</p>\n<p>나는 valtio에 대해 모른다. 하지만 공부하다보니 valtio는 좋은 라이브러리라고 생각한다. (나중에 큰 챕터에서 다뤄보고, 여기서는 간단하게 알아보자!)</p>\n<p>valtio와 zustand immer에서 가장 큰 차이점은 proxy의 사용 방식이다.</p>\n<h2 id=\"immer\"><a class=\"anchor\" href=\"#immer\">immer</a></h2>\n<p>상태 업데이트 시에만 일시적으로 프록시를 생성한다.</p>\n<p><a href=\"https://github.com/immerjs/immer/blob/main/src/core/immerClass.ts\">immerjs의 produce 함수</a>가 실행되는 동안에만 프록시가 존재하고, 업데이트가 완료되면 모든 변경사항을 기록했다가 한번에 새로운 불변 객체를 생성한다.</p>\n<figure data-rehype-pretty-code-figure=\"\"><pre tabindex=\"0\" data-language=\"javascript\" data-theme=\"github-dark github-light\"><code data-language=\"javascript\" data-theme=\"github-dark github-light\" style=\"display: grid;\"><span data-line=\"\"><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">produce</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">(state, (</span><span style=\"--shiki-dark:#FFAB70;--shiki-light:#E36209\">draft</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">) </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">=></span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> {</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">  draft.count </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">+=</span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> 1</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">; </span><span style=\"--shiki-dark:#6A737D;--shiki-light:#6A737D\">// 불변성을 신경쓰지 않고 직접 수정</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">});</span></span></code></pre></figure>\n<h2 id=\"valtio-1\"><a class=\"anchor\" href=\"#valtio-1\">valtio</a></h2>\n<p>상태 객체를 처음 생성할 때부터 프록시로 래핑하고, 이 프록시는 지속적으로 유지된다.</p>\n<p>proxy-compare를 사용하여 상태 변경을 실시간으로 감지하고 추적한다. 곧 설명하겠지만 subscribe 함수를 통해 변경사항을 실시간으로 전파한다.</p>\n<p>쉽게 표현하면 모든 상태 변경이 프록시를 통해 이뤄지므로 실수로 인한 직접 수정을 방지해 연속적인 상태 추적이 가능하다.</p>\n<figure data-rehype-pretty-code-figure=\"\"><pre tabindex=\"0\" data-language=\"javascript\" data-theme=\"github-dark github-light\"><code data-language=\"javascript\" data-theme=\"github-dark github-light\" style=\"display: grid;\"><span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">state.count </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">+=</span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> 1</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">; </span><span style=\"--shiki-dark:#6A737D;--shiki-light:#6A737D\">// 프록시가 자동으로 변경을 감지하고 처리</span></span></code></pre></figure>\n<h2 id=\"어떤-코드-동작으로-immer와-다르게-동작할까\"><a class=\"anchor\" href=\"#어떤-코드-동작으로-immer와-다르게-동작할까\">어떤 코드 동작으로 immer와 다르게 동작할까?</a></h2>\n<figure data-rehype-pretty-code-figure=\"\"><pre tabindex=\"0\" data-language=\"typescript\" data-theme=\"github-dark github-light\"><code data-language=\"typescript\" data-theme=\"github-dark github-light\" style=\"display: grid;\"><span data-line=\"\"><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">const</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\"> createHandlerDefault</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\"> =</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> &#x3C;</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">T</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\"> extends</span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> object</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">>(</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">  isInitializing</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">:</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> () </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">=></span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> boolean</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">,</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">  addPropListener</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">:</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> (</span><span style=\"--shiki-dark:#FFAB70;--shiki-light:#E36209\">prop</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">:</span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> string</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\"> |</span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> symbol</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">, </span><span style=\"--shiki-dark:#FFAB70;--shiki-light:#E36209\">propValue</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">:</span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> unknown</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">) </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">=></span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> void</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">,</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">  removePropListener</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">:</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> (</span><span style=\"--shiki-dark:#FFAB70;--shiki-light:#E36209\">prop</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">:</span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> string</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\"> |</span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> symbol</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">) </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">=></span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> void</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">,</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">  notifyUpdate</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">:</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> (</span><span style=\"--shiki-dark:#FFAB70;--shiki-light:#E36209\">op</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">:</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\"> Op</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">) </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">=></span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> void</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">)</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">:</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\"> ProxyHandler</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">&#x3C;</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">T</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">> </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">=></span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> ({</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">  deleteProperty</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">(</span><span style=\"--shiki-dark:#FFAB70;--shiki-light:#E36209\">target</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">:</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\"> T</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">, </span><span style=\"--shiki-dark:#FFAB70;--shiki-light:#E36209\">prop</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">:</span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> string</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\"> |</span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> symbol</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">) {</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">    const</span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> prevValue</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\"> =</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> Reflect.</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">get</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">(target, prop);</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">    removePropListener</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">(prop);</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">    const</span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> deleted</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\"> =</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> Reflect.</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">deleteProperty</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">(target, prop);</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">    if</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> (deleted) {</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">      notifyUpdate</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">([</span><span style=\"--shiki-dark:#9ECBFF;--shiki-light:#032F62\">\"delete\"</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">, [prop], prevValue]);</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">    }</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">    return</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> deleted;</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">  },</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">  set</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">(</span><span style=\"--shiki-dark:#FFAB70;--shiki-light:#E36209\">target</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">:</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\"> T</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">, </span><span style=\"--shiki-dark:#FFAB70;--shiki-light:#E36209\">prop</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">:</span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> string</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\"> |</span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> symbol</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">, </span><span style=\"--shiki-dark:#FFAB70;--shiki-light:#E36209\">value</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">:</span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> any</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">, </span><span style=\"--shiki-dark:#FFAB70;--shiki-light:#E36209\">receiver</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">:</span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> object</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">) {</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">    const</span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> hasPrevValue</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\"> =</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\"> !</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">isInitializing</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">() </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">&#x26;&#x26;</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> Reflect.</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">has</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">(target, prop);</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">    const</span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> prevValue</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\"> =</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> Reflect.</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">get</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">(target, prop, receiver);</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"--shiki-dark:#6A737D;--shiki-light:#6A737D\">    // objectIs를 통해 캐시된 이전값과 현재 값을 계속 확인한다. 그리고 동일하면 업데이트를 방지한다.</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">    if</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> (</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">      hasPrevValue </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">&#x26;&#x26;</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">      (</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">objectIs</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">(prevValue, value) </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">||</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">        (proxyCache.</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">has</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">(value) </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">&#x26;&#x26;</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\"> objectIs</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">(prevValue, proxyCache.</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">get</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">(value))))</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">    ) {</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">      return</span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> true</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">;</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">    }</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">    removePropListener</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">(prop);</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">    if</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> (</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">isObject</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">(value)) {</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">      value </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">=</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\"> getUntracked</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">(value) </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">||</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> value;</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">    }</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"--shiki-dark:#6A737D;--shiki-light:#6A737D\">    // 중첩된 객체도 자동으로 프록시화 => 이것이 가장 큰 차이같다. immer는 객체 생성할 때, produce 내에서만 불변성을 관리하지만 valtio는 지속적으로 관찰 비교한다.</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">    const</span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> nextValue</span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\"> =</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">      !</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">proxyStateMap.</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">has</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">(value) </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">&#x26;&#x26;</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\"> canProxy</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">(value) </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">?</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\"> proxy</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">(value) </span><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">:</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\"> value;</span></span>\n<span data-line=\"\"> </span>\n<span data-line=\"\"><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">    addPropListener</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">(prop, nextValue);</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">    Reflect.</span><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">set</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">(target, prop, nextValue, receiver);</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#B392F0;--shiki-light:#6F42C1\">    notifyUpdate</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">([</span><span style=\"--shiki-dark:#9ECBFF;--shiki-light:#032F62\">\"set\"</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">, [prop], value, prevValue]);</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#F97583;--shiki-light:#D73A49\">    return</span><span style=\"--shiki-dark:#79B8FF;--shiki-light:#005CC5\"> true</span><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">;</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">  },</span></span>\n<span data-line=\"\"><span style=\"--shiki-dark:#E1E4E8;--shiki-light:#24292E\">});</span></span></code></pre></figure>\n<p>다 안봐도 괜찮다. 주석 작성해둔 부분만 봐도 충분하다.</p>\n<p>나는 valtio를 좋은 라이브러리라고 생각한다. 하지만 valtio를 아직 사용하기에는 타입추론이나 호환성 이슈등 고려해야할 부분이 아직까지 존재하기에 다양한 테스트를 통해 도입을 고려해봐야한다 생각한다.</p>\n<h2 id=\"마지막으로-valtio-장점을-어필해보면\"><a class=\"anchor\" href=\"#마지막으로-valtio-장점을-어필해보면\">마지막으로 valtio 장점을 어필해보면</a></h2>\n<p>메모리 사용량이 낮다. 왜냐면 프록시를 계속 유지하면서 실제 변경된 부분만 업데이트하기때문이다.</p>\n<p>targetCache와 snapCache를 사용하여 불필요한 재생성을 방지하고, 변경된 부분만 효율적으로 업데이트하기에 성능 저하의 우려가 적다.</p>\n<p>useSnapshot 훅을 제공하여 리액트와 긴밀하게 통합되며, 컴포넌트 레벨에서 최적화된 리렌더링을 지원한다.</p>\n<p>실시간 변경을 주로 다루는 부분에서는 valtio 활용이 좋다고 보인다.</p>\n<figure data-rehype-pretty-code-figure=\"\"><pre tabindex=\"0\" data-language=\"toc\" data-theme=\"github-dark github-light\"><code data-language=\"toc\" data-theme=\"github-dark github-light\" style=\"display: grid;\"><span data-line=\"\"> </span></code></pre></figure>"
  },
  "_id": "241116/index.md",
  "_raw": {
    "sourceFilePath": "241116/index.md",
    "sourceFileName": "index.md",
    "sourceFileDir": "241116",
    "contentType": "markdown",
    "flattenedPath": "241116"
  },
  "type": "Post",
  "slug": "/241116",
  "categoryArray": [
    "프론트엔드",
    "자바스크립트"
  ],
  "readingTime": "15 min read",
  "excerpt": "![1.webp](1.webp)\n\nzustand의 immer 그리고 valtio에 대해 알아보기전에 불변성에 대해 간단히 알아보자.\n\n<br/>\n\n 불변성\n\n불변성은 한번 생성된 데이터의 상태가 변경되지 않는다는 개념이다. \n\n직접 수정을 금지하고, 변경이 필요할 때 새로운 객체를 생성해 원본 데이터의 무결성을 유지해야한다.\n\n상태 변경이 직접적인 수정이 ..."
}